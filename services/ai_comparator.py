"""
–ú–æ–¥—É–ª—å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ —Å –ø–æ–º–æ—â—å—é AI
"""
from openai import OpenAI
import json
import re
from typing import List, Dict, Set, Optional
from config.config import (
    OPENROUTER_API_KEY, 
    OPENROUTER_BASE_URL, 
    AI_MODEL, 
    AI_TEMPERATURE,
    MANDATORY_MATCHES,
    is_excluded_column
)
from utils.logger_config import setup_logger
from utils.excel_reader import ExcelReader
from tenacity import (
    retry,
    stop_after_attempt,
    wait_exponential,
    retry_if_exception_type,
    before_sleep_log
)
import logging
import httpx
from config.config import Config
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent))

logger = setup_logger('ai_comparator')

class AIComparatorError(Exception):
    """–ë–∞–∑–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è AIComparator"""
    pass


class AIConnectionError(AIComparatorError):
    """–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI API"""
    pass


class AIResponseError(AIComparatorError):
    """–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ AI"""
    pass

class AIComparator:
    """–ö–ª–∞—Å—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AI"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø—Ä–æ–∫—Å–∏ –∏ timeout"""
        try:
            if Config.PROXY_ENABLED and Config.PROXY_URL:
                logger.info(f"üîÑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏: {Config.PROXY_URL}")
                http_client = httpx.Client(
                    proxy=Config.PROXY_URL,
                    timeout=120.0
                )
                self.client = OpenAI(
                    api_key=Config.OPENROUTER_API_KEY,
                    base_url=Config.OPENROUTER_BASE_URL,
                    http_client=http_client
                )
            else:
                logger.info("üåê –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ OpenRouter API")
                self.client = OpenAI(
                    api_key=Config.OPENROUTER_API_KEY,
                    base_url=Config.OPENROUTER_BASE_URL
                )
            
            self.model = Config.AI_MODEL
            logger.info(f"‚úÖ AI –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–º–æ–¥–µ–ª—å: {self.model})")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AI –∫–ª–∏–µ–Ω—Ç–∞: {e}", exc_info=True)
            raise AIComparatorError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å AI: {e}")
    
    def compare_columns(self, columns_1: List[str], columns_2: List[str], columns_3: List[str]) -> Dict:
        """
        –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç–æ–ª–±—Ü—ã –∏–∑ —Ç—Ä—ë—Ö —Ñ–∞–π–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AI
        """
        try:
            logger.info("=" * 60)
            logger.info("üöÄ –ù–ê–ß–ê–õ–û AI-–°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Ø –°–¢–û–õ–ë–¶–û–í")
            logger.info("=" * 60)
            
            # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
            filtered_1, excluded_1 = self._filter_excluded_columns(columns_1)
            filtered_2, excluded_2 = self._filter_excluded_columns(columns_2)
            filtered_3, excluded_3 = self._filter_excluded_columns(columns_3)
            
            if excluded_1 or excluded_2 or excluded_3:
                logger.info("‚ö†Ô∏è –ò—Å–∫–ª—é—á–µ–Ω—ã —Å—Ç–æ–ª–±—Ü—ã:")
                if excluded_1:
                    logger.info(f"  WB: {', '.join(excluded_1)}")
                if excluded_2:
                    logger.info(f"  Ozon: {', '.join(excluded_2)}")
                if excluded_3:
                    logger.info(f"  –Ø–Ω–¥–µ–∫—Å: {', '.join(excluded_3)}")
            
            logger.info("üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ OpenRouter API...")
            
            # –ü–µ—Ä–≤—ã–π –ø—Ä–æ—Ö–æ–¥
            prompt = self._build_prompt(filtered_1, filtered_2, filtered_3)
            response = self._call_ai_with_retry(prompt)  # üîß –ò–ó–ú–ï–ù–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω retry
            result = self._parse_response(response)
            
            # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
            result = self._add_mandatory_matches(result, filtered_1, filtered_2, filtered_3)
            
            logger.info("‚úÖ –ü–µ—Ä–≤—ã–π –ø—Ä–æ—Ö–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω!")
            logger.info(f"  üìä –¢—Ä–æ–π–Ω—ã–µ: {len(result.get('matches_all_three', []))}")
            logger.info(f"  üìä –ü–∞—Ä–Ω—ã–µ 1-2: {len(result.get('matches_1_2', []))}")
            logger.info(f"  üìä –ü–∞—Ä–Ω—ã–µ 1-3: {len(result.get('matches_1_3', []))}")
            logger.info(f"  üìä –ü–∞—Ä–Ω—ã–µ 2-3: {len(result.get('matches_2_3', []))}")
            
            # –í—Ç–æ—Ä–æ–π –ø—Ä–æ—Ö–æ–¥
            logger.info("-" * 60)
            logger.info("üîÑ –í–¢–û–†–û–ô –ü–†–û–•–û–î")
            
            remaining_columns = self._get_remaining_columns(result, filtered_1, filtered_2, filtered_3)
            
            if remaining_columns[0] or remaining_columns[1] or remaining_columns[2]:
                logger.info(f"üìã –û—Å—Ç–∞–ª–æ—Å—å: WB={len(remaining_columns[0])}, Ozon={len(remaining_columns[1])}, –Ø–Ω–¥–µ–∫—Å={len(remaining_columns[2])}")
                second_result = self._second_pass_comparison(remaining_columns)
                result = self._merge_results(result, second_result)
            else:
                logger.info("‚úÖ –í—Å–µ —Å—Ç–æ–ª–±—Ü—ã —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –ø–µ—Ä–≤–æ–º –ø—Ä–æ—Ö–æ–¥–µ")
            
            # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö
            result = self._add_excluded_to_result(result, excluded_1, excluded_2, excluded_3)
            
            logger.info("=" * 60)
            logger.info("üéâ AI-–°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û")
            logger.info("=" * 60)
            
            return result
            
        except AIComparatorError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ AI: {e}", exc_info=True)
            raise
        except Exception as e:
            logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
            raise AIComparatorError(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
    
    def _filter_excluded_columns(self, columns: List[str]) -> tuple:
        """
        –§–∏–ª—å—Ç—Ä—É–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã
        
        Returns:
            –ö–æ—Ä—Ç–µ–∂ (—Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤, —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤)
        """
        allowed = []
        excluded = []
        
        for col in columns:
            if is_excluded_column(col):
                excluded.append(col)
            else:
                allowed.append(col)
        
        return allowed, excluded
    
    def _add_excluded_to_result(
        self, 
        result: Dict, 
        excluded_1: List[str],
        excluded_2: List[str],
        excluded_3: List[str]
    ) -> Dict:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã –≤ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ
        """
        result['only_in_first'].extend(excluded_1)
        result['only_in_second'].extend(excluded_2)
        result['only_in_third'].extend(excluded_3)
        
        return result
    
    def _get_remaining_columns(
        self, 
        result: Dict, 
        columns_1: List[str], 
        columns_2: List[str], 
        columns_3: List[str]
    ) -> tuple:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –≤–æ—à–ª–∏ –≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç—Ä–µ—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
        
        Returns:
            –ö–æ—Ä—Ç–µ–∂ –∏–∑ —Ç—Ä–µ—Ö —Å–ø–∏—Å–∫–æ–≤ –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
        """
        # –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ç–æ–ª–±—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –£–ñ–ï –≤–æ—à–ª–∏ –≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç—Ä–µ—Ö
        matched_in_all_three_1 = set()
        matched_in_all_three_2 = set()
        matched_in_all_three_3 = set()
        
        # –¢–æ–ª—å–∫–æ –∏–∑ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤—Å–µ—Ö —Ç—Ä–µ—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤!
        for match in result.get('matches_all_three', []):
            col_1 = match.get('column_1')
            col_2 = match.get('column_2')
            col_3 = match.get('column_3')
            
            if col_1:
                matched_in_all_three_1.add(col_1)
            if col_2:
                matched_in_all_three_2.add(col_2)
            if col_3:
                matched_in_all_three_3.add(col_3)
        
        # –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        matched_in_all_three_1.discard('')
        matched_in_all_three_2.discard('')
        matched_in_all_three_3.discard('')
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–∫–∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å—Ç–æ–ª–±—Ü–æ–≤ (–∫–æ—Ç–æ—Ä—ã–µ –ù–ï –≤–æ—à–ª–∏ –≤ matches_all_three)
        remaining_1 = [col for col in columns_1 if col and col not in matched_in_all_three_1]
        remaining_2 = [col for col in columns_2 if col and col not in matched_in_all_three_2]
        remaining_3 = [col for col in columns_3 if col and col not in matched_in_all_three_3]
        
        return (remaining_1, remaining_2, remaining_3)
        
    def _second_pass_comparison(self, remaining_columns: tuple) -> Dict:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Ç–æ—Ä–æ–π –ø—Ä–æ—Ö–æ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å—Ç–æ–ª–±—Ü–æ–≤
        
        Args:
            remaining_columns: –∫–æ—Ä—Ç–µ–∂ –∏–∑ —Ç—Ä–µ—Ö —Å–ø–∏—Å–∫–æ–≤ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å—Ç–æ–ª–±—Ü–æ–≤
        
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Ç–æ—Ä–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞
        """
        remaining_1, remaining_2, remaining_3 = remaining_columns
        
        # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞
        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—é –ø–æ–ª–µ–π —Ç–æ–≤–∞—Ä–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤. 

    –≠–¢–û –í–¢–û–†–û–ô –ü–†–û–•–û–î –ü–†–û–í–ï–†–ö–ò! 

    –ü–µ—Ä–≤—ã–π AI-–∞–Ω–∞–ª–∏–∑ —É–∂–µ –Ω–∞—à–µ–ª –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –º–µ–∂–¥—É –≤—Å–µ–º–∏ —Ç—Ä–µ–º—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º–∏.
    –ù–æ –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç–æ–ª–±—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –≤–æ—à–ª–∏ –≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç—Ä–µ—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤.

    –¢–í–û–Ø –ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê - –Ω–∞–π—Ç–∏ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∏–º–µ–Ω–Ω–æ –ú–ï–ñ–î–£ –í–°–ï–ú–ò –¢–†–ï–ú–Ø –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º–∏!
    –≠—Ç–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ! –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç - –Ω–∞–π—Ç–∏ —Å—Ç–æ–ª–±—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤–æ –í–°–ï–• –¢–†–ï–• —Ñ–∞–π–ª–∞—Ö.

    –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –°–ï–ú–ê–ù–¢–ò–ß–ï–°–ö–û–ì–û –°–†–ê–í–ù–ï–ù–ò–Ø:

    1. –û–ü–ò–°–ê–ù–ò–Ø –ò –¢–ï–ö–°–¢–´:
    - "–û–ø–∏—Å–∞–Ω–∏–µ" = "–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è" = "–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" = "Rich-–∫–æ–Ω—Ç–µ–Ω—Ç" = "–û–ø–∏—Å–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫"
    - "–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è" = "–ö–æ–º–ø–ª–µ–∫—Ç –ø–æ—Å—Ç–∞–≤–∫–∏" = "–ß—Ç–æ –≤ –∫–æ–º–ø–ª–µ–∫—Ç–µ" = "–°–æ—Å—Ç–∞–≤ –∫–æ–º–ø–ª–µ–∫—Ç–∞"
    - "–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏" = "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏" = "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã"

    2. –†–ê–ó–ú–ï–†–´ (–õ–Æ–ë–´–ï –ï–î–ò–ù–ò–¶–´ –ò–ó–ú–ï–†–ï–ù–ò–Ø - –≠–¢–û –û–î–ù–û –ü–û–õ–ï!):
    - "–í—ã—Å–æ—Ç–∞" = "–í—ã—Å–æ—Ç–∞, –º–º" = "–í—ã—Å–æ—Ç–∞, —Å–º" = "–í—ã—Å–æ—Ç–∞ —Ç–æ–≤–∞—Ä–∞" = "–í—ã—Å–æ—Ç–∞ –ø—Ä–µ–¥–º–µ—Ç–∞"
    - "–®–∏—Ä–∏–Ω–∞" = "–®–∏—Ä–∏–Ω–∞, –º–º" = "–®–∏—Ä–∏–Ω–∞, —Å–º" = "–®–∏—Ä–∏–Ω–∞ —Ç–æ–≤–∞—Ä–∞"
    - "–î–ª–∏–Ω–∞" = "–î–ª–∏–Ω–∞, –º–º" = "–î–ª–∏–Ω–∞, —Å–º" = "–ì–ª—É–±–∏–Ω–∞"
    - "–ì–∞–±–∞—Ä–∏—Ç—ã" –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–º–µ—Ä–æ–≤ –≤ –æ–¥–Ω–æ–º –ø–æ–ª–µ
    - "–í–µ—Å" = "–í–µ—Å —Ç–æ–≤–∞—Ä–∞" = "–ú–∞—Å—Å–∞" = "–í–µ—Å, –≥" = "–í–µ—Å, –∫–≥"

    3. –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ò –ú–ï–î–ò–ê:
    - "–§–æ—Ç–æ" = "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" = "–ö–∞—Ä—Ç–∏–Ω–∫–∞" = "–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ" = "URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
    - "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ" = "–î–æ–ø. —Ñ–æ—Ç–æ" = "–ì–∞–ª–µ—Ä–µ—è" = "–§–æ—Ç–æ 1", "–§–æ—Ç–æ 2" –∏ —Ç.–¥.
    - "–í–∏–¥–µ–æ" = "–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ" = "–í–∏–¥–µ–æ–∫–æ–Ω—Ç–µ–Ω—Ç" = "–§–æ—Ç–æ 360"

    4. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò:
    - "–¶–≤–µ—Ç" = "–¶–≤–µ—Ç —Ç–æ–≤–∞—Ä–∞" = "–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç" = "–†–∞—Å—Ü–≤–µ—Ç–∫–∞" = "–¶–≤–µ—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞"
    - "–ú–∞—Ç–µ—Ä–∏–∞–ª" = "–ú–∞—Ç–µ—Ä–∏–∞–ª –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è" = "–°–æ—Å—Ç–∞–≤"
    - "–°—Ç—Ä–∞–Ω–∞" = "–°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞" = "–°—Ç—Ä–∞–Ω–∞-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å" = "–°—Ç—Ä–∞–Ω–∞-–∏–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å"
    - "–ì–∞—Ä–∞–Ω—Ç–∏—è" = "–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Å—Ä–æ–∫" = "–°—Ä–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏–∏"
    - "–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å" = "–ò–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å" = "–ë—Ä–µ–Ω–¥" = "–¢–æ—Ä–≥–æ–≤–∞—è –º–∞—Ä–∫–∞"

    5. –ö–ê–¢–ï–ì–û–†–ò–ò –ò –¢–ò–ü–´:
    - "–¢–∏–ø" = "–í–∏–¥" = "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è" = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" = "–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è"
    - "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ" = "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ" = "–î–ª—è —á–µ–≥–æ"

    6. –û–°–û–ë–´–ï –°–õ–£–ß–ê–ò:
    - –ó–≤–µ–∑–¥–æ—á–∫–∞ (*) –∏–ª–∏ (!) –≤ –∫–æ–Ω—Ü–µ = –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ, –Ω–æ —ç—Ç–æ –¢–û –ñ–ï –ø–æ–ª–µ –±–µ–∑ –∑–≤–µ–∑–¥–æ—á–∫–∏!
    - –ï—Å–ª–∏ –æ–¥–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥—Ä—É–≥–æ–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é - —ç—Ç–æ –ú–û–ñ–ï–¢ –ë–´–¢–¨ –æ–¥–Ω–æ –ø–æ–ª–µ
    - –û–±—Ä–∞—â–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å–º—ã—Å–ª, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–ª–æ–≤

    –û–°–¢–ê–í–®–ò–ï–°–Ø –°–¢–û–õ–ë–¶–´ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ù–ï –≤–æ—à–µ–¥—à–∏–µ –≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç—Ä–µ—Ö):

    –§–∞–π–ª 1 (Wildberries) - {len(remaining_1)} —Å—Ç–æ–ª–±—Ü–æ–≤:
    {json.dumps(remaining_1, ensure_ascii=False, indent=2)}

    –§–∞–π–ª 2 (Ozon) - {len(remaining_2)} —Å—Ç–æ–ª–±—Ü–æ–≤:
    {json.dumps(remaining_2, ensure_ascii=False, indent=2)}

    –§–∞–π–ª 3 (–Ø–Ω–¥–µ–∫—Å –ú–∞—Ä–∫–µ—Ç) - {len(remaining_3)} —Å—Ç–æ–ª–±—Ü–æ–≤:
    {json.dumps(remaining_3, ensure_ascii=False, indent=2)}

    –í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (–±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞):
    {{
        "matches_all_three": [
            {{
                "column_1": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞", 
                "column_2": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ –Ω–∞–±–æ—Ä–∞", 
                "column_3": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Ç—Ä–µ—Ç—å–µ–≥–æ –Ω–∞–±–æ—Ä–∞",
                "confidence": 0.95
            }}
        ],
        "matches_1_2": [
            {{
                "column_1": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞", 
                "column_2": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ –Ω–∞–±–æ—Ä–∞",
                "confidence": 0.90
            }}
        ],
        "matches_1_3": [
            {{
                "column_1": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞", 
                "column_3": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Ç—Ä–µ—Ç—å–µ–≥–æ –Ω–∞–±–æ—Ä–∞",
                "confidence": 0.90
            }}
        ],
        "matches_2_3": [
            {{
                "column_2": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ –Ω–∞–±–æ—Ä–∞", 
                "column_3": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Ç—Ä–µ—Ç—å–µ–≥–æ –Ω–∞–±–æ—Ä–∞",
                "confidence": 0.90
            }}
        ],
        "only_in_first": ["–Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤–æ–º –Ω–∞–±–æ—Ä–µ"],
        "only_in_second": ["–Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ç–æ—Ä–æ–º –Ω–∞–±–æ—Ä–µ"],
        "only_in_third": ["–Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ —Ç–æ–ª—å–∫–æ –≤ —Ç—Ä–µ—Ç—å–µ–º –Ω–∞–±–æ—Ä–µ"]
    }}

    –í–ê–ñ–ù–û: 
    - –ü–†–ò–û–†–ò–¢–ï–¢: –∏—â–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –º–µ–∂–¥—É –í–°–ï–ú–ò –¢–†–ï–ú–Ø —Ñ–∞–π–ª–∞–º–∏ (matches_all_three)!
    - –ë—É–¥—å –û–ß–ï–ù–¨ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º! –≠—Ç–æ –≤—Ç–æ—Ä–æ–π —à–∞–Ω—Å –Ω–∞–π—Ç–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç—Ä–µ—Ö –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤.
    - –ò—Å–ø–æ–ª—å–∑—É–π –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –≤—ã—à–µ –∏ –¥—É–º–∞–π —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏!
    - Confidence –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0.8-1.0 –¥–ª—è —Ö–æ—Ä–æ—à–∏—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    """
        
        response = self._call_ai_with_retry(prompt)
        result = self._parse_response(response)
        return result
    
    def _merge_results(self, first_result: Dict, second_result: Dict) -> Dict:
        """
        –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –∏ –≤—Ç–æ—Ä–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞
        
        Args:
            first_result: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞
            second_result: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Ç–æ—Ä–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞
        
        Returns:
            –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        """
        merged = {
            'matches_all_three': first_result.get('matches_all_three', []) + second_result.get('matches_all_three', []),
            'matches_1_2': first_result.get('matches_1_2', []) + second_result.get('matches_1_2', []),
            'matches_1_3': first_result.get('matches_1_3', []) + second_result.get('matches_1_3', []),
            'matches_2_3': first_result.get('matches_2_3', []) + second_result.get('matches_2_3', []),
            'only_in_first': second_result.get('only_in_first', []),  # –ë–µ—Ä–µ–º –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞
            'only_in_second': second_result.get('only_in_second', []),
            'only_in_third': second_result.get('only_in_third', [])
        }
        return merged
    
    def _build_prompt(
        self, 
        columns_1: List[str], 
        columns_2: List[str], 
        columns_3: List[str]
    ) -> str:
        """–§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è AI (–ø–µ—Ä–≤—ã–π –ø—Ä–æ—Ö–æ–¥)"""
        mandatory_text = "\n".join([
            f"- –§–∞–π–ª 1: '{m['column_1']}' ‚Üî –§–∞–π–ª 2: '{m['column_2']}' ‚Üî –§–∞–π–ª 3: '{m['column_3']}' ({m['description']})"
            for m in MANDATORY_MATCHES
        ])
        
        return f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—é –ø–æ–ª–µ–π —Ç–æ–≤–∞—Ä–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –Ω–∞–π—Ç–∏ –°–ï–ú–ê–ù–¢–ò–ß–ï–°–ö–ò–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –º–µ–∂–¥—É —Å—Ç–æ–ª–±—Ü–∞–º–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–∞–∑–Ω—ã–µ.

–í–ê–ñ–ù–û! –°–ª–µ–¥—É—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã –í–°–ï–ì–î–ê —è–≤–ª—è—é—Ç—Å—è —Å–æ–≤–ø–∞–¥–∞—é—â–∏–º–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è):
{mandatory_text}

–≠—Ç–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —É–∂–µ –∏–∑–≤–µ—Å—Ç–Ω—ã –∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç –∞–Ω–∞–ª–∏–∑–∞.

–ü–†–ê–í–ò–õ–ê –°–ï–ú–ê–ù–¢–ò–ß–ï–°–ö–û–ì–û –°–†–ê–í–ù–ï–ù–ò–Ø:

1. –û–ü–ò–°–ê–ù–ò–Ø –ò –¢–ï–ö–°–¢–´:
   - "–û–ø–∏—Å–∞–Ω–∏–µ" = "–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è" = "–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" = "Rich-–∫–æ–Ω—Ç–µ–Ω—Ç"
   - "–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è" = "–ö–æ–º–ø–ª–µ–∫—Ç –ø–æ—Å—Ç–∞–≤–∫–∏" = "–ß—Ç–æ –≤ –∫–æ–º–ø–ª–µ–∫—Ç–µ"
   - "–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏" = "–û–ø–∏—Å–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫" = "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏"

2. –†–ê–ó–ú–ï–†–´ –ò –ì–ê–ë–ê–†–ò–¢–´:
   - "–í—ã—Å–æ—Ç–∞ —É–ø–∞–∫–æ–≤–∫–∏" = "–í—ã—Å–æ—Ç–∞ —É–ø–∞–∫–æ–≤–∫–∏, –º–º" = "–í—ã—Å–æ—Ç–∞ —É–ø–∞–∫–æ–≤–∫–∏, —Å–º" (—Ä–∞–∑–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã - –æ–¥–Ω–æ –ø–æ–ª–µ!)
   - "–®–∏—Ä–∏–Ω–∞ —É–ø–∞–∫–æ–≤–∫–∏" = "–®–∏—Ä–∏–Ω–∞ —É–ø–∞–∫–æ–≤–∫–∏, –º–º" = "–®–∏—Ä–∏–Ω–∞ —É–ø–∞–∫–æ–≤–∫–∏, —Å–º"
   - "–î–ª–∏–Ω–∞ —É–ø–∞–∫–æ–≤–∫–∏" = "–î–ª–∏–Ω–∞ —É–ø–∞–∫–æ–≤–∫–∏, –º–º" = "–ì–ª—É–±–∏–Ω–∞ —É–ø–∞–∫–æ–≤–∫–∏, –º–º"
   - "–í—ã—Å–æ—Ç–∞ –ø—Ä–µ–¥–º–µ—Ç–∞" = "–í—ã—Å–æ—Ç–∞ —Ç–æ–≤–∞—Ä–∞" = "–í—ã—Å–æ—Ç–∞ –∏–∑–¥–µ–ª–∏—è"
   - "–í–µ—Å" = "–í–µ—Å —Ç–æ–≤–∞—Ä–∞" = "–ú–∞—Å—Å–∞"

3. –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ò –ú–ï–î–ò–ê:
   - "–§–æ—Ç–æ" = "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" = "–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ" = "URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" = "–ö–∞—Ä—Ç–∏–Ω–∫–∞"
   - "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ" = "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" = "–ì–∞–ª–µ—Ä–µ—è"
   - "–í–∏–¥–µ–æ" = "–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ" = "–í–∏–¥–µ–æ–∫–æ–Ω—Ç–µ–Ω—Ç"
   - "–§–æ—Ç–æ 360" = "–ü–∞–Ω–æ—Ä–∞–º–Ω–æ–µ —Ñ–æ—Ç–æ" = "3D –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"

4. –ö–ê–¢–ï–ì–û–†–ò–ò –ò –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø:
   - "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞" = "–¢–∏–ø —Ç–æ–≤–∞—Ä–∞" = "–†–∞–∑–¥–µ–ª"
   - "–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è" = "–ì—Ä—É–ø–ø–∞" = "–í–∏–¥ —Ç–æ–≤–∞—Ä–∞"
   - "–¢–∏–ø" = "–í–∏–¥" = "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è"

5. –¶–ï–ù–´ –ò –°–ö–ò–î–ö–ò:
   - "–¶–µ–Ω–∞" = "–°—Ç–æ–∏–º–æ—Å—Ç—å" = "–¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞" = "–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞"
   - "–¶–µ–Ω–∞ –¥–æ —Å–∫–∏–¥–∫–∏" = "–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞" = "–ó–∞—á–µ—Ä–∫–Ω—É—Ç–∞—è —Ü–µ–Ω–∞"
   - "–°–∫–∏–¥–∫–∞" = "–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏" = "–†–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏"

6. –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨ –ò –°–¢–†–ê–ù–ê:
   - "–°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞" = "–°—Ç—Ä–∞–Ω–∞-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å" = "–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å (—Å—Ç—Ä–∞–Ω–∞)"
   - "–ò–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å" = "–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å" = "–ó–∞–≤–æ–¥-–∏–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å"
   - "–ì–∞—Ä–∞–Ω—Ç–∏—è" = "–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Å—Ä–æ–∫" = "–°—Ä–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏–∏"

7. –£–ü–ê–ö–û–í–ö–ê –ò –õ–û–ì–ò–°–¢–ò–ö–ê:
   - "–û–±—ä–µ–º —É–ø–∞–∫–æ–≤–∫–∏" = "–û–±—ä–µ–º, –ª" = "–û–±—ä—ë–º"
   - "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ" = "–ö–æ–ª-–≤–æ –≤ –∫–æ—Ä–æ–±–∫–µ" = "–®—Ç—É–∫ –≤ —É–ø–∞–∫–æ–≤–∫–µ"
   - "–¢–∏–ø —É–ø–∞–∫–æ–≤–∫–∏" = "–í–∏–¥ —É–ø–∞–∫–æ–≤–∫–∏" = "–£–ø–∞–∫–æ–≤–∫–∞"

8. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´:
   - "–ú–æ—â–Ω–æ—Å—Ç—å" = "–ú–æ—â–Ω–æ—Å—Ç—å, –í—Ç" = "–ü–æ—Ç—Ä–µ–±–ª—è–µ–º–∞—è –º–æ—â–Ω–æ—Å—Ç—å"
   - "–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ" = "–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ, –í" = "–í–æ–ª—å—Ç–∞–∂"
   - "–¶–≤–µ—Ç" = "–¶–≤–µ—Ç —Ç–æ–≤–∞—Ä–∞" = "–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç" = "–†–∞—Å—Ü–≤–µ—Ç–∫–∞"
   - "–ú–∞—Ç–µ—Ä–∏–∞–ª" = "–ú–∞—Ç–µ—Ä–∏–∞–ª –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è" = "–°–æ—Å—Ç–∞–≤"

9. –ü–û–õ–Ø –° –ó–í–ï–ó–î–û–ß–ö–ê–ú–ò –ò –ë–ï–ó:
   - "–ù–∞–∑–≤–∞–Ω–∏–µ*" = "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" = "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" (–∑–≤–µ–∑–¥–æ—á–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç "–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ")
   - "–ë—Ä–µ–Ω–¥*" = "–ë—Ä–µ–Ω–¥" = "–¢–æ—Ä–≥–æ–≤–∞—è –º–∞—Ä–∫–∞"

10. –†–ê–ó–ù–´–ï –§–û–†–ú–ê–¢–´ –û–î–ù–û–ì–û –ü–û–õ–Ø:
   - –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –ø–æ—Ö–æ–∂–∏–µ –ø–æ–ª—è —Å —Ä–∞–∑–Ω—ã–º–∏ –µ–¥–∏–Ω–∏—Ü–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è (–º–º, —Å–º, –≥, –∫–≥) - —ç—Ç–æ –û–î–ù–û –ø–æ–ª–µ
   - –ï—Å–ª–∏ –ø–æ–ª—è –æ—Ç–ª–∏—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–≤–µ–∑–¥–æ—á–∫–æ–π (*) –∏–ª–∏ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∑–Ω–∞–∫–æ–º (!) - —ç—Ç–æ –û–î–ù–û –ø–æ–ª–µ
   - –ï—Å–ª–∏ –æ–¥–Ω–æ –ø–æ–ª–µ –¥–ª–∏–Ω–Ω–µ–µ –¥—Ä—É–≥–æ–≥–æ, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ –∂–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ - —ç—Ç–æ –û–î–ù–û –ø–æ–ª–µ

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1. –ù–∞–π—Ç–∏ –í–°–ï —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –º–µ–∂–¥—É —Ç—Ä–µ–º—è —Ñ–∞–π–ª–∞–º–∏ (–∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª–∞ –≤—ã—à–µ!)
2. –ù–∞–π—Ç–∏ —á–∞—Å—Ç–∏—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –º–µ–∂–¥—É –¥–≤—É–º—è —Ñ–∞–π–ª–∞–º–∏)
3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã –≤ –∫–∞–∂–¥–æ–º —Ñ–∞–π–ª–µ

–ü–µ—Ä–≤—ã–π –Ω–∞–±–æ—Ä —Å—Ç–æ–ª–±—Ü–æ–≤ (Wildberries "–¢–æ–≤–∞—Ä—ã", —Å—Ç—Ä–æ–∫–∞ 3):
{json.dumps(columns_1, ensure_ascii=False, indent=2)}

–í—Ç–æ—Ä–æ–π –Ω–∞–±–æ—Ä —Å—Ç–æ–ª–±—Ü–æ–≤ (Ozon "–®–∞–±–ª–æ–Ω", —Å—Ç—Ä–æ–∫–∞ 2):
{json.dumps(columns_2, ensure_ascii=False, indent=2)}

–¢—Ä–µ—Ç–∏–π –Ω–∞–±–æ—Ä —Å—Ç–æ–ª–±—Ü–æ–≤ (–Ø–Ω–¥–µ–∫—Å –ú–∞—Ä–∫–µ—Ç "–î–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö", —Å—Ç—Ä–æ–∫–∞ 4):
{json.dumps(columns_3, ensure_ascii=False, indent=2)}

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (–±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞):
{{
    "matches_all_three": [
        {{
            "column_1": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞", 
            "column_2": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ –Ω–∞–±–æ—Ä–∞", 
            "column_3": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Ç—Ä–µ—Ç—å–µ–≥–æ –Ω–∞–±–æ—Ä–∞",
            "confidence": 0.95
        }}
    ],
    "matches_1_2": [
        {{
            "column_1": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞", 
            "column_2": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ –Ω–∞–±–æ—Ä–∞",
            "confidence": 0.90
        }}
    ],
    "matches_1_3": [
        {{
            "column_1": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞", 
            "column_3": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Ç—Ä–µ—Ç—å–µ–≥–æ –Ω–∞–±–æ—Ä–∞",
            "confidence": 0.90
        }}
    ],
    "matches_2_3": [
        {{
            "column_2": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ –Ω–∞–±–æ—Ä–∞", 
            "column_3": "—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Ç—Ä–µ—Ç—å–µ–≥–æ –Ω–∞–±–æ—Ä–∞",
            "confidence": 0.90
        }}
    ],
    "only_in_first": ["–Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤–æ–º –Ω–∞–±–æ—Ä–µ"],
    "only_in_second": ["–Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ç–æ—Ä–æ–º –Ω–∞–±–æ—Ä–µ"],
    "only_in_third": ["–Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ —Ç–æ–ª—å–∫–æ –≤ —Ç—Ä–µ—Ç—å–µ–º –Ω–∞–±–æ—Ä–µ"]
}}

–í–ê–ñ–ù–û: 
- –ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º! "–û–ø–∏—Å–∞–Ω–∏–µ" –∏ "–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è" - —ç—Ç–æ –û–î–ù–û –ò –¢–û –ñ–ï!
- Confidence –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0.9-1.0 –¥–ª—è –æ—á–µ–≤–∏–¥–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π (–æ–ø–∏—Å–∞–Ω–∏–µ=–∞–Ω–Ω–æ—Ç–∞—Ü–∏—è)
- Confidence 0.7-0.89 –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö, –Ω–æ –Ω–µ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã—Ö –ø–æ–ª–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö!
"""
    
    @retry(
        stop=stop_after_attempt(3),
        wait=wait_exponential(multiplier=1, min=2, max=30),
        retry=retry_if_exception_type((AIConnectionError, httpx.TimeoutException, httpx.ConnectError)),
        before_sleep=before_sleep_log(logger, logging.WARNING),
        reraise=True
    )
    def _call_ai_with_retry(self, prompt: str) -> str:
        """–í—ã–∑–æ–≤ AI API —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º retry"""
        try:
            logger.debug(f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ AI (–º–æ–¥–µ–ª—å: {self.model})")
            
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": prompt}],
                temperature=Config.AI_TEMPERATURE
            )
            
            content = response.choices[0].message.content
            logger.debug(f"üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç AI ({len(content)} —Å–∏–º–≤–æ–ª–æ–≤)")
            
            return content
            
        except httpx.TimeoutException as e:
            logger.warning(f"‚è±Ô∏è Timeout: {e}")
            raise AIConnectionError(f"–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è: {e}")
        
        except httpx.ConnectError as e:
            logger.warning(f"üîå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
            raise AIConnectionError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è: {e}")
        
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ AI API: {e}", exc_info=True)
            raise AIConnectionError(f"–û—à–∏–±–∫–∞ AI API: {e}")
    
    def _parse_response(self, response_text: str) -> Dict:
        """–ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç –æ—Ç AI"""
        try:
            # 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (–µ—Å–ª–∏ —ç—Ç–æ —á–∏—Å—Ç—ã–π JSON)
            return json.loads(response_text.strip())
        except json.JSONDecodeError:
            pass

        # 2. –ò—â–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞ `````` –∏–ª–∏ ``````
        json_code_block = re.search(r'``````', response_text, re.DOTALL)
        if json_code_block:
            try:
                return json.loads(json_code_block.group(1))
            except json.JSONDecodeError:
                pass

        # 3. –ò—â–µ–º –ø–µ—Ä–≤—É—é –æ—Ç–∫—Ä—ã–≤–∞—é—â—É—é { –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –µ–π –∑–∞–∫—Ä—ã–≤–∞—é—â—É—é }
        try:
            # –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é {
            start_index = response_text.find('{')
            if start_index != -1:
                # –ò—â–µ–º –±–∞–ª–∞–Ω—Å —Å–∫–æ–±–æ–∫, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∑–∞–∫—Ä—ã–≤–∞—é—â—É—é }
                balance = 0
                for i in range(start_index, len(response_text)):
                    char = response_text[i]
                    if char == '{':
                        balance += 1
                    elif char == '}':
                        balance -= 1
                        
                    if balance == 0:
                        json_str = response_text[start_index : i+1]
                        return json.loads(json_str)
        except Exception:
            pass
            
        # 4. –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ - –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø–∞–¥–∞–µ–º
        print("[!] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –æ—Ç–≤–µ—Ç–∞ AI")
        print("Raw response start:", response_text[:200])
        print("Raw response end:", response_text[-200:])
        raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç AI (JSON –Ω–µ –Ω–∞–π–¥–µ–Ω)")
    
    def match_value_with_list(
        self, 
        value: str, 
        allowed_values: List[str],
        column_name: str = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü"  # ‚Üê –î–û–ë–ê–í–ò–¢–¨!
    ) -> Optional[str]:
        """
        –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —á–µ—Ä–µ–∑ AI
        
        Args:
            value: –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            allowed_values: —Å–ø–∏—Å–æ–∫ validation –∑–Ω–∞—á–µ–Ω–∏–π
        
        Returns:
            –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ None
        """
        if not value or not allowed_values:
            return None
        
        # –î–û–ë–ê–í–¨–¢–ï: –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
        def normalize(text: str) -> str:
            """–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–∫—Å—Ç: –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä, —ë‚Üí–µ"""
            return text.lower().replace('—ë', '–µ').strip()
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        value_normalized = normalize(value)
        
        # –°–ù–ê–ß–ê–õ–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
        for allowed in allowed_values:
            if normalize(allowed) == value_normalized:
                print(f"   [normalize] –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: '{value}' ‚Üí '{allowed}'")
                return allowed
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–æ–¥–Ω–æ —Å–ª–æ–≤–æ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤ –¥—Ä—É–≥–æ–º)
        value_words = set(value_normalized.split())
        for allowed in allowed_values:
            allowed_words = set(normalize(allowed).split())
            
            # –ï—Å–ª–∏ –≤—Å–µ —Å–ª–æ–≤–∞ –∏–∑ value –µ—Å—Ç—å –≤ allowed
            if value_words.issubset(allowed_words):
                print(f"   [normalize] –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: '{value}' ‚Üí '{allowed}'")
                return allowed
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - —Å–ø—Ä–∞—à–∏–≤–∞–µ–º AI
        print(f"   [AI] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –¥–ª—è '{value}'...")
        
        prompt = f"""–°–æ–ø–æ—Å—Ç–∞–≤—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å –æ–¥–Ω–∏–º –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ "{column_name}".
        –ò–≥–Ω–æ—Ä–∏—Ä—É–π —Ä–µ–≥–∏—Å—Ç—Ä –∏ —Ä–∞–∑–ª–∏—á–∏—è —ë/–µ.

    –°–¢–û–õ–ë–ï–¶: "{column_name}"    
    –ó–ù–ê–ß–ï–ù–ò–ï: "{value}"

    –î–û–ü–£–°–¢–ò–ú–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø:
    {chr(10).join(f'- {v}' for v in allowed_values)}

    –ü–†–ê–í–ò–õ–ê:
    1. –ù–∞–π–¥–∏ –ù–ê–ò–ë–û–õ–ï–ï –¢–û–ß–ù–û–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    2. "–∑–∞–∫–∞–ª—ë–Ω–Ω–æ–µ —Å—Ç–µ–∫–ª–æ" = "–ó–∞–∫–∞–ª–µ–Ω–Ω–æ–µ —Å—Ç–µ–∫–ª–æ"
    3. –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞, –≤—ã–±–µ—Ä–∏ –±–æ–ª–µ–µ –ø–æ–ª–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    4. –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç - –≤–µ—Ä–Ω–∏ "–ù–ï–¢_–°–û–í–ü–ê–î–ï–ù–ò–Ø"

    –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ "–ù–ï–¢_–°–û–í–ü–ê–î–ï–ù–ò–Ø", –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π."""

        try:
            response = self._call_ai_with_retry(prompt)
            matched = response.strip()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ AI –≤–µ—Ä–Ω—É–ª —á—Ç–æ-—Ç–æ –∏–∑ —Å–ø–∏—Å–∫–∞
            if matched in allowed_values:
                return matched
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
            for allowed in allowed_values:
                if normalize(matched) == normalize(allowed):
                    return allowed
            
            # –ï—Å–ª–∏ AI –≤–µ—Ä–Ω—É–ª "–ù–ï–¢_–°–û–í–ü–ê–î–ï–ù–ò–Ø" –∏–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –∏–∑ —Å–ø–∏—Å–∫–∞
            if "–ù–ï–¢" in matched.upper() or matched not in allowed_values:
                return None
                
            return None
            
        except Exception as e:
            print(f"   [ERROR] –û—à–∏–±–∫–∞ AI: {e}")
            return None


    
    def _add_mandatory_matches(
        self, 
        result: Dict, 
        columns_1: List[str], 
        columns_2: List[str], 
        columns_3: List[str]
    ) -> Dict:
        """–î–æ–±–∞–≤–ª—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç"""
        matches_all = result.get('matches_all_three', [])
        matches_1_2 = result.get('matches_1_2', [])
        matches_1_3 = result.get('matches_1_3', [])
        matches_2_3 = result.get('matches_2_3', [])
        
        for mandatory in MANDATORY_MATCHES:
            col_1 = ExcelReader.find_column_fuzzy(columns_1, mandatory['column_1'])
            col_2 = ExcelReader.find_column_fuzzy(columns_2, mandatory['column_2']) if mandatory['column_2'] else None
            col_3 = ExcelReader.find_column_fuzzy(columns_3, mandatory['column_3']) if mandatory['column_3'] else None
            
            if col_1 and col_2 and col_3:
                exists = any(
                    m.get('column_1') == col_1 or m.get('column_2') == col_2 or m.get('column_3') == col_3
                    for m in matches_all
                )
                if not exists:
                    matches_all.insert(0, {
                        "column_1": col_1,
                        "column_2": col_2,
                        "column_3": col_3,
                        "confidence": 1.0,
                        "mandatory": True
                    })
                    print(f"[+] –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: {mandatory['description']}")
            
            elif col_1 and col_2 and not col_3:
                exists = any(
                    m.get('column_1') == col_1 or m.get('column_2') == col_2
                    for m in matches_1_2
                )
                if not exists:
                    matches_1_2.insert(0, {
                        "column_1": col_1,
                        "column_2": col_2,
                        "confidence": 1.0,
                        "mandatory": True
                    })
            
            elif col_1 and col_3 and not col_2:
                exists = any(
                    m.get('column_1') == col_1 or m.get('column_3') == col_3
                    for m in matches_1_3
                )
                if not exists:
                    matches_1_3.insert(0, {
                        "column_1": col_1,
                        "column_3": col_3,
                        "confidence": 1.0,
                        "mandatory": True
                    })
            
            elif col_2 and col_3 and not col_1:
                exists = any(
                    m.get('column_2') == col_2 or m.get('column_3') == col_3
                    for m in matches_2_3
                )
                if not exists:
                    matches_2_3.insert(0, {
                        "column_2": col_2,
                        "column_3": col_3,
                        "confidence": 1.0,
                        "mandatory": True
                    })
        
        result['matches_all_three'] = matches_all
        result['matches_1_2'] = matches_1_2
        result['matches_1_3'] = matches_1_3
        result['matches_2_3'] = matches_2_3
        
        return result
